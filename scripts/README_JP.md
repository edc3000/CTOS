🌐 Languages: [English](../README_EN.md) | [中文](../README.md) | [日本語](README_JP.md) | [한국어](README_KR.md)
![](logo.png)
## CTOS：暗号通貨取引オペレーティングシステム（Linux設計理念を参考）

**範囲：** 中央集権取引所（CEX）向けの量的取引（初期はOKX、Backpack、Binanceをサポート）。
**設計説明：** CTOSはLinuxの理念（アーキテクチャarch、ドライバdriver、システムコールsyscall、スケジューラscheduler、プロセスprocesses）を参考にしていますが、完全なコピーではありません。堅牢で、組み合わせ可能で、移植可能な取引システムを構築するのに適したアイデアを選択的に採用しています。

### なぜCTOSなのか？

* **移植性：** **統一された取引システムコール（syscall）** を通じて、異なる取引所の違いを抽象化。
* **組み合わせ可能性：** 戦略 = "プロセス"；取引所アダプター = "ドライバ"；各取引所 = "アーキテクチャ"。
* **信頼性：** カーネル/ランタイム/ドライバの階層設計により、テスト性と安全性が向上。
* **可観測性：** 構造化ログ、メトリクス、再現可能なバックテスト機能。
* **高堅牢性** すべての取引所の注文価格と数量精度を統一し、金額指定注文、自動変換、全工程で安心。

---

## 概念マッピング（Linux → CTOS）

| Linux概念 | CTOS対応 | 説明 |
|-----------|----------|------|
| `arch/` | **取引所アーキテクチャ** (`drivers/okx`, `drivers/binance`, `drivers/backpack`) | 各取引所にフォルダを1つ、REST/WS/署名/仕様実装を分離。 |
| デバイスドライバ | **取引所ドライバ** | REST/WSクライアント、署名器、シンボルマップ、機能フラグ。 |
| システムコール | **取引システムコール** | `place_order`、`cancel_order`、`amend_order`、`balances`、`positions`、`subscribe_ticks`など。 |
| スケジューラ | **戦略スケジューラ** | 戦略"プロセス"を調整し、レート制限、リトライ、実行順序を処理。 |
| プロセス | **戦略** | ステートレス/ステートフル戦略、syscallを呼び出し、ランタイムが管理監督。 |
| ファイルシステム | **ストレージ層** | Parquet/SQLiteで市場データ、取引、マーク価格、スナップショット、設定を保存。 |
| `/proc` | **メトリクスと実行時情報** | ヘルス状態、PnL、リスク、レイテンシ、取引所制限、開いているwebsocket。 |
| `init`/systemd | **監督プロセス** | モジュール起動、再起動、クラッシュ分離、ローリング更新。 |

---

## プロジェクトディレクトリ構造

```
ctos/
├─ README.md                    # プロジェクト説明文書
├─ pyproject.toml              # Pythonプロジェクト設定
├─ requirements.txt            # Python依存パッケージ
├─ environment.yml             # Conda環境設定
├─ configs/                    # 設定管理ディレクトリ
│  ├─ account.yaml             # アカウント設定ファイル（APIキー）
│  ├─ account_reader.py        # アカウント設定リーダー
│  ├─ config_reader.py         # 汎用設定リーダー
│  └─ example_usage.py         # 設定使用例
├─ ctos/                       # コアコードディレクトリ
│  ├─ core/                    # コアシステムモジュール
│  │  ├─ kernel/               # システムカーネル
│  │  │  ├─ syscalls.py        # 統一取引システムコールインターフェース
│  │  │  ├─ scheduler.py       # 戦略スケジューラ
│  │  │  └─ event_bus.py       # イベントバス
│  │  ├─ runtime/              # ランタイムシステム
│  │  │  ├─ ExecutionEngine.py # 実行エンジン（コア）
│  │  │  ├─ SystemMonitor.py   # システムモニター
│  │  │  ├─ AccountManager.py  # アカウントマネージャー
│  │  │  ├─ RiskWatcher.py     # リスクモニター
│  │  │  ├─ SignalGenerator.py # シグナルジェネレーター
│  │  │  ├─ DataHandler.py     # データハンドラー
│  │  │  └─ IndicatorCalculator.py # インジケーター計算器
│  │  └─ io/                   # 入出力モジュール
│  │     ├─ logging/           # ログシステム
│  │     ├─ datafeed/          # データソース統合
│  │     └─ storage/           # データストレージ
│  └─ drivers/                 # 取引所ドライバ
│     ├─ okx/                  # OKX取引所ドライバ
│     │  ├─ driver.py          # OKXメインドライバ
│     │  └─ util.py            # OKXユーティリティ関数
│     ├─ backpack/             # Backpack取引所ドライバ
│     │  ├─ driver.py          # Backpackメインドライバ
│     │  └─ util.py            # Backpackユーティリティ関数
│     └─ binance/              # Binance取引所ドライバ
├─ apps/                       # アプリケーション層
│  ├─ strategies/              # 取引戦略
│  │  ├─ grid/                 # グリッド戦略
│  │  │  └─ Grid-All-Coin.py   # 全コイングリッド戦略
│  │  ├─ hedge/                # ヘッジ戦略
│  │  ├─ rank/                 # ランキング戦略
│  │  └─ examples/             # 例戦略
│  ├─ indicatorVisualization/  # インジケーター可視化
│  └─ website/                 # Webインターフェース
├─ tools/                      # ツールセット
├─ scripts/                    # スクリプトファイル
└─ tests/                      # テストファイル
```

### 🔥 コアファイル説明

#### システムコア
- **`ctos/core/runtime/ExecutionEngine.py`** - 実行エンジン、システムコア、戦略実行とシステムコールを担当
- **`ctos/core/runtime/SystemMonitor.py`** - システムモニター、ポジションモニタリング、異常検出と自動修正を担当
- **`ctos/core/kernel/syscalls.py`** - 統一取引システムコールインターフェース、取引所の違いを抽象化

#### 取引所ドライバ
- **`ctos/drivers/okx/driver.py`** - OKX取引所ドライバ、動的アカウントマッピングをサポート
- **`ctos/drivers/backpack/driver.py`** - Backpack取引所ドライバ、動的アカウントマッピングをサポート
- **`ctos/drivers/binance/driver.py`** - Binance取引所ドライバ

#### 設定管理
- **`configs/account.yaml`** - アカウント設定ファイル、各取引所のAPIキーを保存
- **`configs/account_reader.py`** - アカウント設定リーダー、動的アカウント管理をサポート

#### 取引戦略
- **`apps/strategies/grid/Grid-All-Coin.py`** - 全コイングリッド戦略、ExecutionEngineと統合
- **`apps/strategies/examples/`** - 例戦略コレクション

#### モニタリングとログ
- **`ctos/core/io/logging/`** - ログディレクトリ、以下を含む：
  - `{exchange}_Account{id}_{strategy}_system_monitor.log` - システムモニタリングログ
  - `{exchange}_Account{id}_{strategy}_operation_log.log` - 操作ログ
  - `{exchange}_account{id}_position_backup.json` - ポジションバックアップ
  - `{exchange}_account{id}_anomaly_report.json` - 異常レポート

---

## 取引システムコール（統一インターフェース）

> 各取引所のドライバはこれらのインターフェースを実装する必要があります；戦略はExecutionEngineを通じてsyscallを呼び出します。

### 🚀 コア機能概要

#### マーケットデータ関連
- **`get_price_now(symbol)`** - 最新取引価格を取得
- **`get_orderbook(symbol, level)`** - オーダーブック（bid/ask）を取得
- **`get_klines(symbol, timeframe, limit, start_time, end_time)`** - K線データを取得
- **`fees(symbol, limit, offset)`** - 資金調達レートを取得

#### 取引関連
- **`place_order(symbol, side, order_type, size, price=None, **kwargs)`** - 注文
- **`revoke_order(order_id, symbol)`** - 注文キャンセル
- **`amend_order(order_id, symbol, ...)`** - 注文修正（照会→キャンセル→注文）
- **`get_open_orders(symbol=None, instType='SWAP')`** - 未完了注文を取得
- **`get_order_status(order_id, keep_origin=False)`** - 注文ステータスを照会
- **`cancel_all(symbol)`** - 指定取引ペアの全注文をキャンセル

#### アカウント/ポジション
- **`fetch_balance(currency)`** - 残高を取得（複数通貨サポート）
- **`get_position(symbol=None, keep_origin=False)`** - ポジション情報を取得
- **`close_all_positions(symbol=None)`** - 全ポジションをクローズ

### 🔧 実行エンジン機能

#### ExecutionEngineコアメソッド
- **`place_incremental_orders(amount, coin, side, soft=True)`** - 増分注文
- **`set_coin_position(coin, usdt_amount, soft=True)`** - コインポジション設定
- **`_order_tracking_logic(coins, soft_orders_to_focus)`** - 注文追跡ロジック

#### システムモニタリング機能
- **`monitor_positions()`** - ポジションモニタリング（自動修正サポート）
- **`get_position_summary()`** - ポジションサマリーを取得
- **`get_anomaly_summary()`** - 異常サマリーを取得
- **`start_position_monitoring()`** - 連続モニタリングを開始

### 📊 サポート取引所

| 取引所 | ドライバファイル | アカウントサポート | 特殊機能 |
|--------|------------------|-------------------|----------|
| **OKX** | `drivers/okx/driver.py` | 動的アカウントマッピング | 完全な先物取引サポート |
| **Backpack** | `drivers/backpack/driver.py` | 動的アカウントマッピング | ネイティブ永続契約サポート |
| **Binance** | `drivers/binance/driver.py` | 基本サポート | 世界最大の取引所 |

### 🎯 動的アカウント管理

すべての取引所ドライバは`account_id`パラメータを通じた動的アカウント選択をサポート：

```python
# メインアカウントを使用 (account_id=0)
engine = ExecutionEngine(account=0, exchange_type='okx')

# サブアカウントを使用 (account_id=1)
engine = ExecutionEngine(account=1, exchange_type='backpack')

# 3番目のアカウントを使用 (account_id=2)
engine = ExecutionEngine(account=2, exchange_type='okx')
```

アカウントマッピングは`configs/account.yaml`設定ファイルに基づく：
- `account_id=0` → 最初のアカウント（通常はmain）
- `account_id=1` → 2番目のアカウント（通常はsub1）
- `account_id=2` → 3番目のアカウント（通常はsub2）

---

## 🏗️ システムアーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                        CTOSシステムアーキテクチャ              │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ アプリケーション層 │  │ 設定層 (Config)  │  │ ツール層 (Tools)  │ │
│  │ (Apps)          │  │                │  │                │ │
│  │                 │  │ • アカウント設定 │  │ • バックテスト   │ │
│  │ • グリッド戦略   │  │ • システム設定   │  │ • シミュレーター │ │
│  │ • ヘッジ戦略     │  │ • キー管理       │  │ • 可視化        │ │
│  │ • ランキング戦略 │  │                │  │                │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                コアランタイム (Core Runtime)              │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │ │
│  │  │ 実行エンジン │  │ システム     │  │ アカウント   │    │ │
│  │  │             │  │ モニター     │  │ マネージャー │    │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘    │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │ │
│  │  │ リスク       │  │ シグナル     │  │ データ       │    │ │
│  │  │ ウォッチャー │  │ ジェネレーター│  │ ハンドラー   │    │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘    │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                   システムカーネル (Kernel)               │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │ │
│  │  │ システム     │  │ 戦略        │  │ イベント     │    │ │
│  │  │ コール       │  │ スケジューラ │  │ バス         │    │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘    │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                 取引所ドライバ (Drivers)                 │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │ │
│  │  │   OKX       │  │  Backpack   │  │  Binance    │    │ │
│  │  │   Driver    │  │   Driver    │  │   Driver    │    │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘    │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                   データストレージ (Storage)              │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │ │
│  │  │ ログ        │  │ データフィード│  │ ストレージ   │    │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘    │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 🔄 データフロー
1. **戦略** → **実行エンジン** → **システムコール** → **取引所ドライバ** → **取引所API**
2. **取引所API** → **取引所ドライバ** → **システムコール** → **実行エンジン** → **システムモニター**
3. **システムモニター** → **異常検出** → **自動修正** → **実行エンジン** → **取引所ドライバ**

---

## 🌟 システム特性

### 🔥 コア機能
- **統一取引インターフェース** - 1つのAPIでOKX、Backpack、Binanceの3大取引所をサポート
- **動的アカウント管理** - 複数アカウント切り替えをサポート、設定ベースの自動マッピング
- **スマートポジションモニタリング** - quantityUSDベースの精密モニタリング、自動修正をサポート
- **多次元異常検出** - 価格、ポジション、利益、リスクの包括的モニタリング
- **自動修正メカニズム** - 異常検出時の自動注文修正
- **完全ログシステム** - 構造化ログ、操作記録、異常レポート

### 🛡️ セキュリティ特性
- **リスクコントロール** - 内蔵リスク管理モジュール、複数リスク指標モニタリングをサポート
- **アカウント分離** - 独立した複数アカウント管理、相互汚染を回避
- **操作監査** - 完全な操作記録と異常追跡
- **自動サーキットブレーカー** - 異常時の自動取引停止

### 🚀 パフォーマンス特性
- **高精度計算** - 取引所間の精度差を統一処理
- **スマート注文** - 価格と数量精度変換の自動処理
- **増分取引** - 増分注文をサポート、重複操作を回避
- **リアルタイムモニタリング** - 連続モニタリングとスケジュールタスクをサポート

---

### 🎯 CTOS設計目標（初心者向け）

1. **即座に使用可能** — ワンクリック起動、複雑な環境設定不要。
   👉 初心者でも数分で最初の取引戦略を実行可能。

2. **コード不要** — 内蔵の一般的な戦略。
   👉 「平均回帰」、「グリッド」、「ヘッジ」を1コマンドで実行、プログラミング不要でも楽しめる。

3. **複数取引所統一インターフェース**
   👉 1つのシステムでOKX、Binance、Backpackに同時接続、様々なAPIを学ぶ必要がない。

4. **デフォルトセキュリティ保護**
   👉 内蔵リスクコントロールと緊急遮断で、初心者によくある大損失を回避。

5. **まずシミュレーション、その後実取引**
   👉 まず「仮想資金」で訓練とテスト、安心して学習、損失を心配する必要がない。

6. **結果可視化**
   👉 自動生成される収益、リスク、パフォーマンスのチャートレポートで一目で理解。

7. **段階的学習**
   👉 まず既存戦略 → 設定パラメータを変更 → 最後にプログラミングを学びたい時は自分で書く。

---

## クイックスタート（実践フロー）

1. **コード取得**
   リポジトリをクローン：

   ```bash
   git clone https://github.com/CryptoFxxker/CTOS.git
   cd ctos
   ```

2. **環境構築**

   ```bash
   conda create -n ctos python=3.10 -y
   conda activate ctos
   pip install -U pip
   pip install -r requirements.txt
   ```

3. **APIキー設定**

   ```bash
   cp configs/secrets.example.yaml configs/account.yaml
   ```

   **OKX / Backpack / Binance** のAPIキーを入力

   ### 3.1 テストケース（オプション）

   環境とAPIキー設定が正しいか検証するには、内蔵テストスクリプトを実行：

   ```bash
   python configs/example_usage.py
   ```

   このスクリプトはOKXとBackpack取引所の主流コインで自動的に注文テストを実行し、結果を出力します。初回デプロイ時に先に実行し、すべて正常であることを確認することをお勧めします。
   > ⚠️ このファイルをgitにコミットしないでください

4. **内蔵戦略実行**

   ```bash
   # 全コイングリッド戦略を実行
   python apps/strategies/grid/Grid-All-Coin.py
   
   # または他の戦略を実行
   python apps/strategies/examples/your_strategy.py
   ```

   戦略は自動的にExecutionEngineとSystemMonitorを使用して実行とモニタリングを行います。

6. **バックテスト/リプレイ@TODO** 
   履歴データを`tools/backtest/`に配置し、次に：

   ```bash
   ./scripts/backtest.sh
   ```

   結果は`var/logs/`に書き込まれ、`var/data/`に保存されます。

👉 フローは一目瞭然：**コード取得 → 環境インストール → APIキー入力 → 設定 → 実取引開始**

---

## ロードマップ

* **v0.1**
  システムコール仕様；取引所ドライバ（OKX/Backpack/Binance）骨格；ランタイムスケジューリング；シミュレーション取引

* **v0.2**
  統一WebSocketデータストリーム；バックテストとシミュレーションの一貫性；より豊富なリスクコントロールモジュール

* **v0.3**
  複数取引所ポートフォリオ純資産管理；リアルタイム災害復旧；ホットリスタート；より強力なインジケーターとユーザーインターフェース

* **🎉 マイルストーン1（2025.09.17）**
  ✅ 2つの取引所APIの統一設計と抽象化を完了。
  🚀 今日重要なマイルストーンを達成：**システムコールベースのAI自動生成グリッド戦略コード**が完成し、微調整後に正式にリリース！
  🥂🎊 リリースおめでとう、未来に期待！

* **🎉 マイルストーン2（2025.09.）**
  ✅ quantityUSDベースの精密ポジションモニタリングシステムを完了
  ✅ 多次元異常検出（価格、ポジション、利益、リスク）を実装
  ✅ 自動修正メカニズムを完了、ポジション異常の自動修復をサポート
  ✅ 完全なログシステムとデータ永続化を実装
  ✅ OKX、Backpack、Binanceの3大取引所をサポート
  🚀 システムは本番環境デプロイ能力を備えています！
  🥂🎊 リリースおめでとう、未来に期待！

---

## セキュリティとコンプライアンス

* **最小権限**：APIキーは必要な取引権限のみを有効化し、出金は常に無効化。
* **キーセキュリティ**：`configs/secrets.yaml`（バージョン管理に含まれない）を使用するか、システムキー管理、環境変数。
* **リスクコントロール優先**：注文前チェック、遮断、Kill-switch、レート制限とログ記録。
* **バックテスト再現可能**：すべての戦略入力/出力と市場スナップショットがリプレイ可能。

---

## ライセンスと免責事項

* **免責事項**：暗号通貨取引は極めて高いリスクを伴います。CTOSは研究/ツールフレームワークとして提供され、リスクを自己評価し、責任を負ってください。
* **ライセンス**：お好みのライセンス（MIT / Apache-2.0 / GPL-3.0）を選択し、`LICENSE`ファイルで明確に指定してください。
